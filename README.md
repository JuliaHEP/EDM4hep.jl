# EDM4hep in Julia

Prototype of the [EDM4hep](https://github.com/key4hep/EDM4hep) (generic Event Data Model for HEP experiments part of Key4hep) for Julia with the goal to have very simple structures (isbits) with the purpose to evaluate its ergonomic design and implementation performance.

## PODIO generation
The Julia POD `structs` should be generated from the the [edm4hep.yaml](https://github.com/key4hep/EDM4hep/blob/main/edm4hep.yaml) yaml file using [PODIO](https://github.com/AIDASoft/podio) scripts.

For the time being, for this evaluation, the **Julia structs are generated by a local Julia script** in `./podio/generate.jl`. The files `genComponents/jl` and `genDatatypes.jl` are fully generated. 

## Main design features
- All EDM4hep entities are **immutable structs** and containing basic types and structs. Including the relationships (one-to-one and one-to-many). Objects attributes cannot be changed. This makes the objects `isbits(obj) == true`.

- Objects are created by default not being registered, they are **free floating**. The user can register them with `register(obj)`.
- Note that operations like `register`, setting  relationships (`add_daughter`,...), etc. **will automatically create a new instances**. The typical pattern is to overwrite the user variable with the new instance, e.g.:
  ```
  p1 = MCParticle(...)
  p1 = register(p1)
  p1, d1 = add_daugther(p1, MCParticle(...))
  ```
- The main goal for reading EDM4hep containers from a ROOT file is to obtain as result a `StructArray`. This provides a very efficient access by column and the same time provide a convenient views as object instances. For example if you want to sum the momentum os a range of `MCParticles` the user sould be able to write:
  ```julia
  julia> mcparticles = get(reader,...)
  julia> mcparticles[5:8].momentum
  4-element StructArray(::Vector{Float32}, ::Vector{Float32}, ::Vector{Float32}) with eltype Vector3f:
    (0.8740664,-0.002116337,124.84335)
    (0.8602309,-0.056633994,-124.632545)
    (-0.00012483617,0.0021162117,0.0026654897)
    (0.014539731,0.05663412,-0.32755017)

  julia> sum(mcparticles[5:8].momentum)
    (1.7487122,0.0,-0.11407688)
  ``` 

## Examples
### examples/test1.jl
Creates a collection of `MCParticles` and a collection of `SimTrackerHits` in memory, constructing the relations between particle `parents` and `daughters`, as well as, the the one-to-one relation between the simulation hit to the originator `MCParticle`.

### examples/read.jl
An example of reading from a ROOT file created by the C++ implementation of EDM4hep. This is the full code:
```julia
using EDM4hep
using EDM4hep.RootIO

f = "/Users/mato/Downloads/example_edm4hep2.root"
#f = "https://cernbox.cern.ch/remote.php/dav/public-files/yOmBeyVaiYpj46S/example_edm4hep2.root"

reader = RootIO.Reader(f)
events = RootIO.get(reader, "events")

evt = events[1];
set_hits = RootIO.get(reader, evt, "SETCollection")
mcps =  RootIO.get(reader, evt, "MCParticle")

for hit in set_hits
    println("Hit $(hit.index) is related to MCParticle $(hit.mcparticle.index) with PDG $(hit.mcparticle.PDG)")
end

for p in mcps
    println("MCParticle $(p.index) with PDG=$(p.PDG) and momentum $(p.momentum) and energy $(p.energy) has $(length(p.daughters)) daughters")
    for d in p.daughters
        println("   ---> $(d.index) with PDG=$(d.PDG) and momentum $(d.momentum) has $(length(d.parents)) parents")
        for m in d.parents
            println("      ---> $(m.index) with PDG=$(m.PDG)")
        end 
    end
end

```

